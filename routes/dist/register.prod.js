"use strict";var express=require("express"),router=express.Router(),connection=require("../config/db"),bcrypt=require("bcryptjs"),session=require("express-session"),iplocation=require("iplocation");router.get("/",function(e,r){r.render("register",{title:"Inscription",user:e.session.user})}),router.post("/",function(i,t){i.body.username&&i.body.email&&i.body.firstname&&i.body.lastname&&i.body.password&&i.body.confirmPassword?connection.query("SELECT * FROM users WHERE username = ? OR email = ?",[i.body.username,i.body.email],function(e,r,s){if(e)console.log(e);else if(80<i.body.firstname.length||80<i.body.lastname.length||80<i.body.username.length||200<i.body.email.length)i.session.error="Erreur.",t.redirect("/register");else if(-1!=i.body.username.search(/[^a-zA-Z0-9]/))i.session.error="Le nom d'utilisateur ne peux contenir que des lettres et des chiffres.",t.redirect("/register");else if(r[0]&&r[0].username)i.session.error="Le nom d'utilisateur ou l'email est déjà utilisé.",t.redirect("/register");else if(r[0]&&r[0].email)i.session.error="L'email est déjà utilisé.",t.redirect("/register");else if(i.body.password!=i.body.confirmPassword)i.session.error="Les mots de passe ne correspondent pas.",t.redirect("/register");else if(i.body.password.length<6)i.session.error="Erreur: votre mot de passe doit faire plus de 6 charactères",t.redirect("/register");else if(50<i.body.password.length)i.session.error="Erreur: votre mot de passe doit faire moins de 50 charactères",t.redirect("/register");else if(-1==i.body.password.search(/\d/))i.session.error="Erreur: votre mot de passe doit contenir au moins un chiffre",t.redirect("/register");else if(-1==i.body.password.search(/[a-z]/))i.session.error="Erreur: votre mot de passe doit contenir au moins une minuscule",t.redirect("/register");else if(-1==i.body.password.search(/[A-Z]/))i.session.error="Erreur: votre mot de passe doit contenir au moins une majuscule",t.redirect("/register");else if(-1!=i.body.password.search(/[^a-zA-Z0-9\!\@\#\$\%\^\&\*\(\)\_\+\.\,\\:]/))i.session.error="Erreur: votre mot de passe ne peux pas contenir d'autres charactères que a-z A-Z 0-9 ! @ # $ % ^ & * ( ) _ + . ,  :",t.redirect("/register");else{var o=bcrypt.hashSync(i.body.password,12);connection.query("INSERT INTO users SET username = ?, lastname = ?, firstname = ?, email = ?, password = ?, inscription_date = ?, visit = ?",[i.body.username,i.body.lastname,i.body.firstname,i.body.email,o,new Date,new Date],function(e,r){e?(i.session.error="Erreur.",t.redirect("/profil")):(iplocation(i.ip,function(e,r){r&&r.city?connection.query("UPDATE users SET city = ?, lat = ?, lon = ? WHERE username = ?",[r.city,r.latitude,r.longitude,i.body.username],function(e){e&&console.log(e)}):connection.query('UPDATE users SET city = "Lyon", lat = 45.739240, lon = 4.817450 WHERE username = ?',[i.body.username],function(e){e&&console.log(e)})}),i.session.success="Votre compte a correctement été créé",t.redirect("/login"))})}}):(i.session.error="Erreur",t.redirect("/register"))}),module.exports=router;